{"created":"2023-05-08T20:36:17.87108Z","extra":{"kind":"study","sourceInputsCount":0},"lastVersionMaj":"9.0","scriptAccess":"open_no_auth","scriptName":"Market Structure Break & Order Block","source":"// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/\r\n// Â© EmreKb\r\n\r\n//@version=5\r\nindicator(\"Market Structure Break & Order Block\", \"MSB-OB\", overlay=true, max_lines_count=500, max_bars_back=4900, max_boxes_count=500)\r\n\r\nsettings = \"Settings\"\r\nzigzag_len = input.int(9, \"ZigZag Length\", group=settings)\r\nshow_zigzag = input.bool(true, \"Show Zigzag\", group=settings)\r\nfib_factor = input.float(0.33, \"Fib Factor for breakout confirmation\", 0, 1, 0.01, group=settings)\r\n\r\ntext_size = input.string(size.tiny, \"Text Size\", [size.tiny, size.small, size.normal, size.large, size.huge], group=settings)\r\n\r\ndelete_boxes = input.bool(true, \"Delete Old/Broken Boxes\", group=settings)\r\n\r\nbu_ob_inline_color = \"Bu-OB Colors\"\r\nbe_ob_inline_color = \"Be-OB Colors\"\r\nbu_bb_inline_color = \"Bu-BB Colors\"\r\nbe_bb_inline_color = \"Be-BB Colors\"\r\n\r\nbu_ob_display_settings = \"Bu-OB Display Settings\"\r\nbu_ob_color = input.color(color.new(color.green, 70), \"Color\", group=bu_ob_display_settings, inline=bu_ob_inline_color)\r\nbu_ob_border_color = input.color(color.green, \"Border Color\", group=bu_ob_display_settings, inline=bu_ob_inline_color)\r\nbu_ob_text_color = input.color(color.green, \"Text Color\", group=bu_ob_display_settings, inline=bu_ob_inline_color)\r\n\r\nbe_ob_display_settings = \"Be-OB Display Settings\"\r\nbe_ob_color = input.color(color.new(color.red, 70), \"Color\", group=be_ob_display_settings, inline=be_ob_inline_color)\r\nbe_ob_border_color = input.color(color.red, \"Border Color\", group=be_ob_display_settings, inline=be_ob_inline_color)\r\nbe_ob_text_color = input.color(color.red, \"Text Color\", group=be_ob_display_settings, inline=be_ob_inline_color)\r\n\r\nbu_bb_display_settings = \"Bu-BB & Bu-MB Display Settings\"\r\nbu_bb_color = input.color(color.new(color.green, 70), \"Color\", group=bu_bb_display_settings, inline=bu_bb_inline_color)\r\nbu_bb_border_color = input.color(color.green, \"Border Color\", group=bu_bb_display_settings, inline=bu_bb_inline_color)\r\nbu_bb_text_color = input.color(color.green, \"Text Color\", group=bu_bb_display_settings, inline=bu_bb_inline_color)\r\n\r\nbe_bb_display_settings = \"Be-BB & Be-MB Display Settings\"\r\nbe_bb_color = input.color(color.new(color.red, 70), \"Color\", group=be_bb_display_settings, inline=be_bb_inline_color)\r\nbe_bb_border_color = input.color(color.red, \"Border Color\", group=be_bb_display_settings, inline=be_bb_inline_color)\r\nbe_bb_text_color = input.color(color.red, \"Text Color\", group=be_bb_display_settings, inline=be_bb_inline_color)\r\n\r\n\r\nvar float[] high_points_arr = array.new_float(5)\r\nvar int[] high_index_arr = array.new_int(5)\r\nvar float[] low_points_arr = array.new_float(5)\r\nvar int[] low_index_arr = array.new_int(5)\r\n\r\nvar box[] bu_ob_boxes = array.new_box(5)\r\nvar box[] be_ob_boxes = array.new_box(5)\r\nvar box[] bu_bb_boxes = array.new_box(5)\r\nvar box[] be_bb_boxes = array.new_box(5)\r\n\r\nto_up = high >= ta.highest(zigzag_len)\r\nto_down = low <= ta.lowest(zigzag_len)\r\n\r\ntrend = 1\r\ntrend := nz(trend[1], 1)\r\ntrend := trend == 1 and to_down ? -1 : trend == -1 and to_up ? 1 : trend\r\n\r\nlast_trend_up_since = ta.barssince(to_up[1])\r\nlow_val = ta.lowest(nz(last_trend_up_since > 0 ? last_trend_up_since : 1, 1))\r\nlow_index = bar_index - ta.barssince(low_val == low)\r\n\r\nlast_trend_down_since = ta.barssince(to_down[1])\r\nhigh_val = ta.highest(nz(last_trend_down_since > 0 ? last_trend_down_since : 1, 1))\r\nhigh_index = bar_index - ta.barssince(high_val == high)\r\n\r\nif ta.change(trend) != 0\r\n    if trend == 1\r\n        array.push(low_points_arr, low_val)\r\n        array.push(low_index_arr, low_index)\r\n    if trend == -1\r\n        array.push(high_points_arr, high_val)\r\n        array.push(high_index_arr, high_index)\r\n\r\n\r\nf_get_high(ind) =>\r\n    [array.get(high_points_arr, array.size(high_points_arr) - 1 - ind), array.get(high_index_arr, array.size(high_index_arr) - 1 - ind)]\r\n\r\n\r\nf_get_low(ind) =>\r\n    [array.get(low_points_arr, array.size(low_points_arr) - 1 - ind), array.get(low_index_arr, array.size(low_index_arr) - 1 - ind)]\r\n\r\n\r\nf_delete_box(box_arr) =>\r\n    if delete_boxes\r\n        box.delete(array.shift(box_arr))\r\n    else\r\n        array.shift(box_arr)\r\n    0\r\n\r\n\r\n[h0, h0i] = f_get_high(0)\r\n[h1, h1i] = f_get_high(1)\r\n\r\n[l0, l0i] = f_get_low(0)\r\n[l1, l1i] = f_get_low(1)\r\n\r\nif ta.change(trend) != 0 and show_zigzag\r\n    if trend == 1\r\n        line.new(h0i, h0, l0i, l0)\r\n    if trend == -1\r\n        line.new(l0i, l0, h0i, h0)\r\n\r\nmarket = 1\r\nmarket := nz(market[1], 1)\r\n// market := market == 1 and close < l0 and low < l0 - math.abs(h0 - l0) * fib_factor ? -1 : market == -1 and close > h0 and high > h0 + math.abs(h0 - l0) * fib_factor ? 1 : market\r\nlast_l0 = ta.valuewhen(ta.change(market) != 0, l0, 0)\r\nlast_h0 = ta.valuewhen(ta.change(market) != 0, h0, 0)\r\nmarket := last_l0 == l0 or last_h0 == h0 ? market : market == 1 and l0 < l1 and l0 < l1 - math.abs(h0 - l1) * fib_factor ? -1 : market == -1 and h0 > h1 and h0 > h1 + math.abs(h1 - l0) * fib_factor ? 1 : market\r\n\r\nbu_ob_index = bar_index\r\nbu_ob_index := nz(bu_ob_index[1], bar_index)\r\nfor i=h1i to l0i[zigzag_len]\r\n    index = bar_index - i \r\n    if open[index] > close[index]\r\n        bu_ob_index := bar_index[index]\r\n\r\nbu_ob_since = bar_index - bu_ob_index\r\n\r\nbe_ob_index = bar_index\r\nbe_ob_index := nz(be_ob_index[1], bar_index)\r\nfor i=l1i to h0i[zigzag_len]\r\n    index = bar_index - i \r\n    if open[index] < close[index]\r\n        be_ob_index := bar_index[index]\r\n\r\nbe_ob_since = bar_index - be_ob_index\r\n\r\nbe_bb_index = bar_index\r\nbe_bb_index := nz(be_bb_index[1], bar_index)\r\nfor i=h1i - zigzag_len to l1i\r\n    index = bar_index - i\r\n    if open[index] > close[index]\r\n        be_bb_index := bar_index[index]\r\n\r\nbe_bb_since = bar_index - be_bb_index\r\n\r\nbu_bb_index = bar_index\r\nbu_bb_index := nz(bu_bb_index[1], bar_index)\r\nfor i=l1i - zigzag_len to h1i\r\n    index = bar_index - i\r\n    if open[index] < close[index]\r\n        bu_bb_index := bar_index[index]\r\n\r\nbu_bb_since = bar_index - bu_bb_index\r\n\r\nif ta.change(market) != 0\r\n    if market == 1\r\n        line.new(h1i, h1, h0i, h1, color=color.green, width=2)\r\n        label.new(int(math.avg(h1i, l0i)), h1, \"MSB\", color=color.new(color.black, 100), style=label.style_label_down, textcolor=color.green, size=size.small)\r\n        bu_ob = box.new(bu_ob_index, high[bu_ob_since], bar_index + 10, low[bu_ob_since], bgcolor=bu_ob_color, border_color=bu_ob_border_color, text=\"Bu-OB\", text_color=bu_ob_text_color, text_halign=text.align_right, text_size=text_size)\r\n        bu_bb = box.new(bu_bb_index, high[bu_bb_since], bar_index + 10, low[bu_bb_since], bgcolor=bu_bb_color, border_color=bu_bb_border_color, text=l0 < l1 ? \"Bu-BB\" : \"Bu-MB\", text_color=bu_bb_text_color, text_halign=text.align_right, text_size=text_size)\r\n        array.push(bu_ob_boxes, bu_ob)\r\n        array.push(bu_bb_boxes, bu_bb)\r\n    if market == -1\r\n        line.new(l1i, l1, l0i, l1, color=color.red, width=2)\r\n        label.new(int(math.avg(l1i, h0i)), l1, \"MSB\", color=color.new(color.black, 100), style=label.style_label_up, textcolor=color.red, size=size.small)\r\n        be_ob = box.new(be_ob_index, high[be_ob_since], bar_index + 10, low[be_ob_since], bgcolor=be_ob_color, border_color=be_ob_border_color, text=\"Be-OB\", text_color=be_ob_text_color, text_halign=text.align_right, text_size=text_size)\r\n        be_bb = box.new(be_bb_index, high[be_bb_since], bar_index + 10, low[be_bb_since], bgcolor=be_bb_color, border_color=be_bb_border_color, text=h0 > h1 ? \"Be-BB\" : \"Be-MB\", text_color=be_bb_text_color, text_halign=text.align_right, text_size=text_size)\r\n        array.push(be_ob_boxes, be_ob)\r\n        array.push(be_bb_boxes, be_bb)\r\n\r\nfor bull_ob in bu_ob_boxes\r\n    bottom = box.get_bottom(bull_ob)\r\n    top = box.get_top(bull_ob)\r\n    if close < bottom\r\n        f_delete_box(bu_ob_boxes)\r\n    else if close < top\r\n        alert(\"Price in the BU-OB zone\")\r\n    else\r\n        box.set_right(bull_ob, bar_index + 10)\r\n    \r\nfor bear_ob in be_ob_boxes\r\n    top = box.get_top(bear_ob)\r\n    bottom = box.get_bottom((bear_ob))\r\n    if close > top\r\n        f_delete_box(be_ob_boxes)\r\n    if close > bottom\r\n        alert(\"Price in the BE-OB zone\")\r\n    else\r\n        box.set_right(bear_ob, bar_index + 10)\r\n        \r\nfor bear_bb in be_bb_boxes\r\n    top = box.get_top(bear_bb)\r\n    bottom = box.get_bottom(bear_bb)\r\n    if close > top\r\n        f_delete_box(be_bb_boxes)\r\n    else if close > bottom\r\n        alert(\"Price in the BE-BB zone\")\r\n    else\r\n        box.set_right(bear_bb, bar_index + 10)\r\n        \r\nfor bull_bb in bu_bb_boxes\r\n    bottom = box.get_bottom(bull_bb)\r\n    top = box.get_top(bull_bb)\r\n    if close < bottom\r\n        f_delete_box(bu_bb_boxes)\r\n    else if close < top\r\n        alert(\"Price in the BU-BB zone\")\r\n    else\r\n        box.set_right(bull_bb, bar_index + 10)\r\n\r\n\r\nalertcondition(ta.change(market) != 0, \"MSB\", \"MSB\")\r\n","updated":"2023-05-08T20:36:17.87108Z","version":"9.0"}